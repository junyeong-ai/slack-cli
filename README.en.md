# Slack CLI

[![CI](https://github.com/junyeong-ai/slack-cli/workflows/CI/badge.svg)](https://github.com/junyeong-ai/slack-cli/actions)
[![Lint](https://github.com/junyeong-ai/slack-cli/workflows/Lint/badge.svg)](https://github.com/junyeong-ai/slack-cli/actions)
[![Rust](https://img.shields.io/badge/rust-1.91.1%2B%20(2024%20edition)-orange?style=flat-square&logo=rust)](https://www.rust-lang.org)
[![License](https://img.shields.io/badge/license-MIT-green?style=flat-square)](LICENSE)
[![Version](https://img.shields.io/badge/version-0.1.0-blue?style=flat-square)](https://github.com/junyeong-ai/slack-cli/releases)

> **ğŸŒ [í•œêµ­ì–´](README.md)** | **English**

---

> **âš¡ Fast and Powerful Slack Command-Line Tool**
>
> - ğŸš€ **Millisecond searches** (SQLite FTS5 full-text search)
> - ğŸ’¾ **Local cache** (instant user/channel queries)
> - ğŸ” **Fuzzy matching** (typo-tolerant search)
> - ğŸ› ï¸ **9 commands** (search, messaging, config management)

---

## âš¡ Quick Start (1 minute)

```bash
# 1. Install
git clone https://github.com/junyeong-ai/slack-cli
cd slack-cli
cargo build --release

# 2. Global install (optional)
./install.sh

# 3. Initialize config
slack config init --bot-token xoxb-your-token

# 4. Refresh cache
slack cache refresh

# 5. Start using! ğŸ‰
slack users "john"
slack channels "general"
slack send "#general" "Hello team!"
```

**ğŸ’¡ Tip**: Using a user token (`xoxp-`) provides more features.

---

## ğŸ¯ Key Features

### ğŸ” Powerful Search
```bash
# Search users (name, email, display name)
slack users "john" --limit 5

# Search channels (name, topic, description)
slack channels "dev" --limit 10

# Search messages (workspace-wide)
slack search "deadline" --channel "#dev-team"
```

### ğŸ’¬ Message Management
```bash
# Send message to channel
slack send "#general" "Meeting in 10 minutes"

# Send DM
slack send "@john.doe" "Hello!"

# Reply to thread
slack send "#dev-team" "Done!" --thread 1234567890.123456

# Get channel messages
slack messages "#general" --limit 20

# Get full thread
slack thread "#dev-team" 1234567890.123456
```

### ğŸ“‹ Channel Management
```bash
# List channel members
slack members "#dev-team"

# JSON output
slack channels "general" --json | jq
```

### âš™ï¸ Cache & Config
```bash
# Check cache status
slack cache stats

# Refresh cache
slack cache refresh           # all
slack cache refresh --users   # users only
slack cache refresh --channels # channels only

# Config management
slack config show            # show config (masked tokens)
slack config path            # config file path
slack config edit            # edit with default editor
```

---

## ğŸ“¦ Installation

### Prerequisites
- Rust 1.91.1+ (2024 edition)
- Slack workspace access

### Method 1: Build from Source

```bash
git clone https://github.com/junyeong-ai/slack-cli
cd slack-cli
cargo build --release

# Binary location: target/release/slack
```

### Method 2: Global Install

```bash
# After building, install globally
./install.sh

# Uninstall
./uninstall.sh
```

### Method 3: Cargo

```bash
# Coming soon
cargo install slack-cli
```

---

## ğŸ”‘ Generate Slack Token

### User Token (Recommended) â­

1. Visit [api.slack.com/apps](https://api.slack.com/apps)
2. "Create New App" â†’ "From scratch"
3. Add **User Token Scopes**:
   ```
   channels:read channels:history groups:read groups:history
   im:read im:history mpim:read mpim:history
   users:read users:read.email chat:write search:read
   ```
4. "Install to Workspace" â†’ Copy token (starts with `xoxp-`)

### Bot Token (Alternative)

1. Same app creation as above
2. Add **Bot Token Scopes**:
   ```
   channels:read channels:history groups:read groups:history
   im:read im:history mpim:read mpim:history
   users:read users:read.email chat:write
   ```
3. "Install to Workspace" â†’ Copy token (starts with `xoxb-`)

### Token Comparison

| Feature | User Token â­ | Bot Token |
|---------|--------------|-----------|
| Channel Access | âœ… Automatic | âš ï¸ Requires invitation |
| Message Search | âœ… Available | âŒ Unavailable |
| Sender | You | Bot account |

---

## âš™ï¸ Configuration

### Environment Variables

```bash
export SLACK_BOT_TOKEN="xoxb-..."      # Bot token
export SLACK_USER_TOKEN="xoxp-..."    # User token (recommended)
```

### Config File

**Location**:
- macOS: `~/Library/Application Support/slack-cli/config.toml`
- Linux: `~/.config/slack-cli/config.toml`
- Windows: `%APPDATA%\slack-cli\config.toml`

**Default config** (generated by `slack config init`):
```toml
bot_token = "xoxb-..."
user_token = "xoxp-..."

[cache]
ttl_users_hours = 24
ttl_channels_hours = 24
data_path = "~/.local/share/slack-cli/cache"  # macOS: ~/Library/...

[retry]
max_attempts = 3
initial_delay_ms = 1000
max_delay_ms = 60000

[connection]
timeout_seconds = 30
max_idle_per_host = 10
```

### Config Priority

```
CLI flags > Environment variables > Config file > Defaults
```

**Example**:
```bash
# Override config file token
slack users "john" --token xoxp-temporary-token
```

---

## ğŸ—ï¸ Architecture

### Core Technologies

**Fast Search**:
- **SQLite FTS5**: Full-text search engine (< 10ms queries)
- **WAL Mode**: Concurrent read/write
- **2-Phase Search**: LIKE exact match â†’ FTS5 fuzzy match

**Cache Strategy**:
- **Full Load**: Cache all users/channels on startup
- **TTL-Based**: Auto-refresh after 24 hours
- **Distributed Lock**: Multi-process safety

**Performance Optimizations**:
- **Rust 2024**: Memory safety + high performance
- **Tokio Async**: Asynchronous I/O
- **Connection Pool**: HTTP connection reuse
- **Rate Limiting**: Auto-retry + exponential backoff

### System Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Terminal   â”‚  stdin  â”‚   Slack CLI      â”‚  HTTPS  â”‚    Slack    â”‚
â”‚   Commands   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚   (clap/Tokio)   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Workspace  â”‚
â”‚              â”‚  stdout â”‚                  â”‚         â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚   SQLite Cache  â”‚
                          â”‚   (WAL + FTS5)  â”‚
                          â”‚                 â”‚
                          â”‚ â€¢ User FTS5     â”‚
                          â”‚ â€¢ Channel FTS5  â”‚
                          â”‚ â€¢ Distributed   â”‚
                          â”‚   locking       â”‚
                          â”‚ â€¢ Metadata      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Why Caching is Essential

**Slack API Limitations**:
- ğŸš« No channel name search API
- â±ï¸ Low rate limit (Tier 2: 20 calls/min)
- ğŸŒ Repeated queries inefficient

**Caching Solution**:
- ğŸš€ Full load on startup
- ğŸ” Local FTS5 search (< 10ms)
- âš¡ Zero API calls
- ğŸ”„ TTL-based auto-refresh

**Performance Comparison**:

| Operation | Slack API | Cache (FTS5) | Improvement |
|-----------|-----------|--------------|-------------|
| User Search | ~500ms + rate limit | **<10ms** | **50x+** |
| Channel Search | âŒ Unavailable | **<10ms** | **Enabled** |
| Consecutive Queries | Rate limited | **Unlimited** | **No constraints** |

---

## ğŸ”§ Troubleshooting

### Cache Not Refreshing

```bash
# Delete and recreate cache
rm -rf ~/.local/share/slack-cli/cache  # Linux
rm -rf ~/Library/Application\ Support/slack-cli/cache  # macOS

# Run again
slack cache refresh
```

### "Unauthorized" Error

**Checklist**:
- [ ] Check token format (`xoxp-` or `xoxb-`)
- [ ] Verify required scopes added
- [ ] Confirm workspace reinstall

**Test token**:
```bash
curl -H "Authorization: Bearer xoxp-YOUR-TOKEN" \
  https://slack.com/api/auth.test
```

### Message Search Not Working

**Cause**: Missing user token or `search:read` scope

**Solution**:
1. Set `SLACK_USER_TOKEN` (`xoxp-`)
2. Add `search:read` scope
3. Reinstall to workspace

### Debug Logging

```bash
RUST_LOG=debug slack users "john"
RUST_LOG=slack_cli::cache=trace slack cache refresh
```

### Inspect Cache Data

```bash
sqlite3 ~/.local/share/slack-cli/cache/slack.db

# Useful queries
SELECT COUNT(*) FROM users;
SELECT COUNT(*) FROM channels;
SELECT * FROM metadata;

# Cache freshness
SELECT
    key,
    datetime(CAST(value AS INTEGER), 'unixepoch') as last_sync,
    (unixepoch() - CAST(value AS INTEGER)) / 3600 as hours_ago
FROM metadata
WHERE key LIKE 'last_%_sync';
```

---

## ğŸ“š Command Reference

### slack users

Search users (name, email, display name)

```bash
slack users <query> [OPTIONS]

OPTIONS:
  --limit <N>      Limit results [default: 10]
  --json           JSON output format
  --token <TOKEN>  Override token temporarily

EXAMPLES:
  slack users "john"
  slack users "@gmail.com" --limit 20
  slack users "smith" --json | jq
```

### slack channels

Search channels (public/private/DM/group DM)

```bash
slack channels <query> [OPTIONS]

OPTIONS:
  --limit <N>  Limit results [default: 10]
  --json       JSON output format

EXAMPLES:
  slack channels "dev"
  slack channels "general" --limit 5
```

### slack send

Send message

```bash
slack send <channel> <text> [OPTIONS]

OPTIONS:
  --thread <TS>  Thread timestamp (for replies)

EXAMPLES:
  slack send "#general" "Hello team!"
  slack send "@john.doe" "Hi John"
  slack send "#dev" "Fixed" --thread 1234567890.123456
```

### slack messages

Get channel messages

```bash
slack messages <channel> [OPTIONS]

OPTIONS:
  --limit <N>  Number of messages [default: 100, max: 1000]
  --json       JSON output format

EXAMPLES:
  slack messages "#general"
  slack messages "#dev-team" --limit 50
```

### slack thread

Get full thread

```bash
slack thread <channel> <timestamp> [OPTIONS]

OPTIONS:
  --limit <N>  Number of replies [default: 100]
  --json       JSON output format

EXAMPLES:
  slack thread "#general" 1234567890.123456
```

### slack members

List channel members

```bash
slack members <channel> [OPTIONS]

OPTIONS:
  --json  JSON output format

EXAMPLES:
  slack members "#dev-team"
```

### slack search

Search messages (workspace-wide)

```bash
slack search <query> [OPTIONS]

OPTIONS:
  --channel <CH>  Limit to specific channel
  --limit <N>     Limit results [default: 10]
  --json          JSON output format

EXAMPLES:
  slack search "deadline"
  slack search "bug" --channel "#dev-team"

NOTE: Requires user token (xoxp-) + search:read scope
```

### slack cache

Cache management

```bash
slack cache <COMMAND>

COMMANDS:
  stats    Show cache statistics (user/channel counts)
  refresh  Refresh cache [--users|--channels]
  path     Show cache file path

EXAMPLES:
  slack cache stats
  slack cache refresh
  slack cache refresh --users
  slack cache path
```

### slack config

Config management

```bash
slack config <COMMAND>

COMMANDS:
  init [OPTIONS]  Initialize config
  show            Show config (masked tokens)
  path            Show config file path
  edit            Edit with default editor

EXAMPLES:
  slack config init --bot-token xoxb-...
  slack config show
  slack config edit
```

---

## ğŸš€ Development

### Building

```bash
git clone https://github.com/junyeong-ai/slack-cli
cd slack-cli

cargo build                # Development build
cargo build --release      # Optimized build
cargo test                 # Run tests (65 tests)
cargo clippy              # Lint
cargo fmt                 # Format
```

### Project Structure

```
src/
â”œâ”€â”€ main.rs              # Entry point: Tokio runtime, config, CLI execution
â”œâ”€â”€ cli.rs               # clap-based CLI command definitions
â”œâ”€â”€ config.rs            # Config management (priority: CLI > ENV > File)
â”œâ”€â”€ format.rs            # Output formatting (text/JSON)
â”œâ”€â”€ cache/               # SQLite cache
â”‚   â”œâ”€â”€ sqlite_cache.rs # Main implementation
â”‚   â”œâ”€â”€ schema.rs       # FTS5 schema
â”‚   â”œâ”€â”€ users.rs        # User caching
â”‚   â”œâ”€â”€ channels.rs     # Channel caching
â”‚   â”œâ”€â”€ locks.rs        # Distributed locking
â”‚   â””â”€â”€ helpers.rs      # Utilities
â””â”€â”€ slack/              # Slack API client
    â”œâ”€â”€ client.rs       # Unified facade
    â”œâ”€â”€ core.rs         # HTTP + Rate Limiting
    â”œâ”€â”€ users.rs        # User API
    â”œâ”€â”€ channels.rs     # Channel API
    â””â”€â”€ messages.rs     # Message API
```

**Developer Guide**: [CLAUDE.md](CLAUDE.md) - AI agent-specialized development docs

---

## ğŸ“„ License

MIT License - [LICENSE](LICENSE)

---

## ğŸ’¬ Support

- **GitHub Issues**: [Report issues](https://github.com/junyeong-ai/slack-cli/issues)
- **Developer Docs**: [CLAUDE.md](CLAUDE.md)

---

<div align="center">

**ğŸŒ [í•œêµ­ì–´](README.md)** | **English**

**Version 0.1.0** â€¢ Rust 2024 Edition

Made with â¤ï¸ for productivity

</div>
